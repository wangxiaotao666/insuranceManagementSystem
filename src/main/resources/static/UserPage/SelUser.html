<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>更新用户信息</title>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script type="text/javascript">
		// 页面加载时获取当前用户信息
		window.onload = function () {
			// 从 localStorage 获取登录时保存的用户信息
			const username = localStorage.getItem('username');
			const password = localStorage.getItem('password');

			if (!username || !password) {
				alert('请先登录！');
				window.location.href = '/login.html';
				return;
			}

			// 获取用户信息
			axios.get(`/userUpdate/getUserInfo?username=${username}&password=${password}`)
					.then(response => {
						if (response.data) {
							const userData = response.data;
							// 填充表单字段，注意所有字段都作为字符串处理
							document.getElementById('user_id').value = userData.user_id || '';
							document.getElementById('username').value = userData.username;
							document.getElementById('password').value = userData.password;
							document.getElementById('name').value = userData.name;
							document.getElementById('sex').value = userData.sex;
							document.getElementById('age').value = userData.age;
							document.getElementById('phone').value = userData.phone;
							document.getElementById('address').value = userData.address;
							document.getElementById('type').value = userData.type || '';
						} else {
							alert('获取用户信息失败');
						}
					})
					.catch(error => {
						console.error('获取用户数据失败:', error);
						alert('获取用户信息失败');
					});
		};

		// 提交表单
		function submitForm(event) {
			event.preventDefault();

			// 构建更新数据对象，确保与 UserList 类的字段完全匹配
			const updateData = {
				user_id: document.getElementById('user_id').value,
				username: document.getElementById('username').value,
				password: document.getElementById('password').value,
				name: document.getElementById('name').value,
				sex: document.getElementById('sex').value,
				age: document.getElementById('age').value,
				phone: document.getElementById('phone').value,
				address: document.getElementById('address').value,
				type: document.getElementById('type').value
			};

			// 发送更新请求
			axios.post('/userUpdate/updateUserInfo', updateData)
					.then(response => {
						alert('用户信息更新成功!');
						// 更新本地存储的密码
						localStorage.setItem('password', updateData.password);
					})
					.catch(error => {
						console.error('更新失败:', error);
						alert('更新失败, 请稍后重试!');
					});
		}
	</script>
</head>
<body>
<h1>更新个人信息</h1>
<form onsubmit="submitForm(event)">
	<table class="tb" id="list">
		<tbody>
		<tr>
			<th>帐号</th>
			<th>密码</th>
			<th>姓名</th>
			<th>性别</th>
			<th>年龄</th>
			<th>电话</th>
			<th>联系地址</th>
			<th>操作</th>
		</tr>
		<tr class="demo">
			<!-- 隐藏字段 -->
			<input type="hidden" id="user_id" />
			<input type="hidden" id="type" />

			<td><input type="text" id="username" readonly /></td>
			<td><input type="password" id="password" /></td>
			<td><input type="text" id="name" /></td>
			<td>
				<select id="sex">
					<option value="男">男</option>
					<option value="女">女</option>
				</select>
			</td>
			<td><input type="text" id="age" /></td>
			<td><input type="text" id="phone" /></td>
			<td><input type="text" id="address" /></td>
			<td><input type="submit" class="btn btn-mini btn-danger" value="更新信息" /></td>
		</tr>
		</tbody>
	</table>
</form>
</body>
</html>